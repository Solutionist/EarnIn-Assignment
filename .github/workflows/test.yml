name: Test Suite

on:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Start Docker services
      run: docker compose up -d
    
    - name: Wait for services
      run: |
        echo "Waiting for services to start..."
        sleep 10
        
        # Check postgres
        for i in {1..30}; do
          if docker compose exec -T postgres pg_isready -U postgres 2>/dev/null; then
            echo "PostgreSQL is ready"
            break
          fi
          sleep 2
        done
        
        # Check wiremock
        for i in {1..20}; do
          if curl -sf http://localhost:8081/__admin/mappings > /dev/null; then
            echo "Wiremock is ready"
            break
          fi
          sleep 2
        done
        
        # Check API
        for i in {1..15}; do
          if curl -sf http://localhost:8000/ > /dev/null; then
            echo "API is ready"
            break
          fi
          sleep 2
        done
    
    - name: Setup database
      run: docker compose exec -T postgres psql -h localhost -U postgres airline -f /home/scripts/schema.sql
    
    - name: Run tests
      env:
        AIRLINE_API_URL: http://localhost:8000
        WIREMOCK_URL: http://localhost:8081
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/airline
      run: pytest tests/ -v --junitxml=test-results.xml
    
    - name: Publish test results
      if: always()
      uses: EnricoMi/publish-unit-test-result-action@v2.21.0
      with:
        files: 'test-results.xml'
        check_name: Test Results
        comment_mode: always
